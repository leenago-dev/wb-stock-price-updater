# POST /sync-stocks-name 목적 상세 설명

## 핵심 목적

**"종목 목록 동기화"**는 **프론트엔드에서 사용자가 심볼을 입력할 때 종목명을 보여주기 위한 메타데이터를 수집하고 저장하는 작업**입니다.

---

## 구체적인 문제 상황

### 문제 1: 사용자가 심볼만 알고 종목명을 모를 때

**시나리오**:
```
사용자가 프론트엔드에서 "AAPL"을 입력
    ↓
프론트엔드: "이게 뭐지? 종목명이 뭐야?"
    ↓
백엔드에 종목명 조회 요청 필요
```

**해결**:
```
POST /sync-stocks-name 실행
    ↓
FDR에서 종목 목록 수집
    ↓
stock_names 테이블에 저장
    {
      "symbol": "AAPL",
      "name": "Apple Inc.",
      "country": "US"
    }
    ↓
프론트엔드: GET /stocks-name/AAPL
    ↓
응답: {"symbol": "AAPL", "name": "Apple Inc.", ...}
    ↓
화면에 "Apple Inc." 표시 ✅
```

### 문제 2: 신규 상장 종목이 생겼을 때

**시나리오**:
```
2025년 1월: 새로운 회사가 나스닥에 상장
    ↓
기존 DB에는 없음
    ↓
사용자가 새 심볼을 입력해도 종목명을 알 수 없음
```

**해결**:
```
정기적으로 POST /sync-stocks-name 실행
    ↓
FDR에서 최신 종목 목록 수집
    ↓
신규 종목이 있으면 자동으로 추가
    ↓
사용자가 새 심볼을 입력해도 종목명 표시 가능 ✅
```

### 문제 3: 상장폐지된 종목 처리

**시나리오**:
```
어떤 종목이 상장폐지됨
    ↓
더 이상 거래되지 않음
    ↓
하지만 DB에는 여전히 활성화되어 있음
```

**해결**:
```
POST /sync-stocks-name 실행
    ↓
FDR에서 현재 상장된 종목만 수집
    ↓
기존 DB의 활성 종목 중 이번에 없는 종목 발견
    ↓
자동으로 is_active = false로 비활성화
    ↓
더 이상 수집 대상에서 제외 ✅
```

---

## 실제 동작 과정

### 1단계: FDR에서 종목 목록 수집

```
POST /sync-stocks-name
    ↓
각 시장별로 병렬 수집:
    ├─ KRX (한국 주식) → 약 2,500개 종목
    ├─ ETF/KR (한국 ETF) → 약 200개 종목
    ├─ S&P500 (미국) → 500개 종목
    ├─ NASDAQ (미국) → 약 3,000개 종목
    ├─ NYSE (미국) → 약 2,000개 종목
    └─ AMEX (미국) → 약 200개 종목
    ↓
총 약 8,000개 종목 수집
```

**수집되는 데이터 예시**:
```python
[
    {"symbol": "AAPL", "name": "Apple Inc.", "country": "US"},
    {"symbol": "MSFT", "name": "Microsoft Corporation", "country": "US"},
    {"symbol": "005930", "name": "삼성전자", "country": "KR"},
    {"symbol": "000660", "name": "SK하이닉스", "country": "KR"},
    ...
]
```

### 2단계: Supabase에 저장

```
stock_names 테이블에 upsert
    ↓
기존 종목: 업데이트 (이름 변경 등 반영)
신규 종목: 추가
    ↓
예시:
    - AAPL → "Apple Inc." (업데이트)
    - NEWSTOCK → "New Company Inc." (신규 추가)
```

### 3단계: 상장폐지 종목 비활성화

```
기존 활성 종목: [AAPL, MSFT, OLDSTOCK]
현재 수집된 종목: [AAPL, MSFT, NEWSTOCK]
    ↓
비교:
    - AAPL: 유지 (활성)
    - MSFT: 유지 (활성)
    - OLDSTOCK: 누락 → is_active = false (비활성화)
    - NEWSTOCK: 신규 → 추가 (활성)
```

---

## 실제 사용 사례

### 사례 1: 프론트엔드 종목 검색 기능

**프론트엔드 화면**:
```
┌─────────────────────────────┐
│ 종목 검색                    │
├─────────────────────────────┤
│ [AAPL 입력 중...]           │
│                             │
│ 검색 결과:                   │
│ ✓ AAPL - Apple Inc. (US)   │
└─────────────────────────────┘
```

**동작**:
```
1. 사용자가 "AAPL" 입력
2. 프론트엔드: GET /stocks-name/AAPL
3. 백엔드: stock_names 테이블에서 조회
4. 응답: {"symbol": "AAPL", "name": "Apple Inc.", "country": "US"}
5. 화면에 "AAPL - Apple Inc. (US)" 표시
```

**이 기능이 작동하려면**:
- `stock_names` 테이블에 데이터가 있어야 함
- 최신 종목 목록이 반영되어 있어야 함
- → **POST /sync-stocks-name으로 주기적으로 동기화 필요**

### 사례 2: 사용자가 티커 입력 시 자동완성

**프론트엔드 화면**:
```
┌─────────────────────────────┐
│ 주식 가격 조회                │
├─────────────────────────────┤
│ 티커: [0059 입력 중...]     │
│                             │
│ 자동완성:                    │
│ • 005930 - 삼성전자 (KR)    │
│ • 005935 - 삼성전자우 (KR)  │
└─────────────────────────────┘
```

**동작**:
```
1. 사용자가 "0059" 입력
2. 프론트엔드: stock_names 테이블에서 "0059"로 시작하는 종목 검색
   (또는 프론트엔드에서 전체 목록을 로드하여 필터링)
3. 매칭되는 종목 목록 표시
```

**이 기능이 작동하려면**:
- `stock_names` 테이블에 한국 종목 데이터가 있어야 함
- → **POST /sync-stocks-name으로 KRX 시장 동기화 필요**

### 사례 3: 종목 선택 시 상세 정보 표시

**프론트엔드 화면**:
```
┌─────────────────────────────┐
│ 주식 포트폴리오              │
├─────────────────────────────┤
│ 종목: AAPL                  │
│ 이름: Apple Inc.            │
│ 국가: US                    │
│ 통화: USD                   │
│ 현재가: $185.50              │
└─────────────────────────────┘
```

**동작**:
```
1. 사용자가 "AAPL" 선택
2. 프론트엔드: GET /stocks-name/AAPL
3. 백엔드: stock_names 테이블에서 조회
4. 응답: {"symbol": "AAPL", "name": "Apple Inc.", "country": "US", ...}
5. 화면에 종목 정보 표시
```

---

## 왜 정기적으로 동기화가 필요한가?

### 1. 신규 상장 종목

```
매일 새로운 회사가 상장됨
    ↓
FDR에는 즉시 반영됨
    ↓
하지만 우리 DB에는 없음
    ↓
정기 동기화로 최신 종목 추가 필요
```

### 2. 종목명 변경

```
회사명이 변경될 수 있음
    예: "Facebook" → "Meta Platforms Inc."
    ↓
FDR에서 최신 이름으로 업데이트
    ↓
동기화로 DB에도 반영 필요
```

### 3. 상장폐지 처리

```
상장폐지된 종목은 더 이상 거래되지 않음
    ↓
FDR 목록에서 사라짐
    ↓
동기화 시 자동으로 비활성화
    ↓
더 이상 수집 대상에서 제외
```

---

## 동기화 주기 권장사항

### 주 1회 (권장)

```bash
# Cloud Scheduler 설정
매주 월요일 오전 9시 실행
```

**이유**:
- 신규 상장은 자주 발생하지 않음
- 종목명 변경도 드묾
- 주 1회면 충분히 최신 상태 유지 가능

### 매일 실행 (선택사항)

```bash
# 더 자주 업데이트하고 싶다면
매일 오전 9시 실행
```

**장점**:
- 최신 종목 정보 즉시 반영
- 종목명 변경 빠르게 반영

**단점**:
- 불필요한 API 호출 증가
- 처리 시간 소요

---

## 요약

### POST /sync-stocks-name의 목적

1. **프론트엔드 종목 검색 기능 지원**
   - 사용자가 심볼 입력 시 종목명 표시
   - 자동완성 기능 지원

2. **최신 종목 목록 유지**
   - 신규 상장 종목 자동 추가
   - 상장폐지 종목 자동 비활성화

3. **종목 메타데이터 제공**
   - 종목명, 국가, 통화 등 정보 제공
   - 프론트엔드에서 종목 정보 표시

### 핵심 가치

**"사용자가 심볼만 입력해도 종목명을 볼 수 있게 하는 것"**

```
사용자: "AAPL이 뭐지?"
    ↓
POST /sync-stocks-name (주 1회 실행)
    ↓
stock_names 테이블에 저장
    {
      "symbol": "AAPL",
      "name": "Apple Inc."
    }
    ↓
사용자가 "AAPL" 입력
    ↓
GET /stocks-name/AAPL
    ↓
화면에 "Apple Inc." 표시 ✅
```

---

## 실제 예시

### 동기화 전

```
stock_names 테이블:
- AAPL: "Apple Inc." (있음)
- MSFT: "Microsoft Corp." (있음)
- NEWSTOCK: (없음) ← 신규 상장 종목
```

### 동기화 실행

```bash
POST /sync-stocks-name
```

### 동기화 후

```
stock_names 테이블:
- AAPL: "Apple Inc." (업데이트됨)
- MSFT: "Microsoft Corporation" (이름 변경 반영)
- NEWSTOCK: "New Company Inc." (신규 추가) ✅
- OLDSTOCK: is_active=false (상장폐지로 비활성화)
```

---

**결론**: `POST /sync-stocks-name`은 **프론트엔드에서 종목 정보를 표시하기 위한 메타데이터를 최신 상태로 유지하는 작업**입니다.
